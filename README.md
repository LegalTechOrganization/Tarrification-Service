# BillingTariffication-Service

–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∏–∫–∞—Ü–∏–µ–π –∏ –∫–≤–æ—Ç–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ LegaTech.

> **–í–Ω–∏–º–∞–Ω–∏–µ**: –≠—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å–µ—Ä–≤–∏—Å, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π —Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ–∂—Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è. –í–Ω–µ—à–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ Gateway.

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–°–µ—Ä–≤–∏—Å —Ä–µ—à–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–¥–∞—á–∏:
- **–£—á—ë—Ç —Ç–∞—Ä–∏—Ñ–æ–≤/–ª–∏–º–∏—Ç–æ–≤** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (Chat- –∏ Template-–∫–≤–æ—Ç—ã)
- **–°–ø–∏—Å–∞–Ω–∏–µ** –∫–≤–æ—Ç—ã –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–ª–∞—Ç–Ω–æ–º –≤—ã–∑–æ–≤–µ
- **–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ** –±–∞–ª–∞–Ω—Å–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
- **–ê–≤—Ç–æ-reset** –¥–Ω–µ–≤–Ω—ã—Ö/–º–µ—Å—è—á–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤
- **–û—Ç—á—ë—Ç–Ω–æ—Å—Ç—å –∏ –º–µ—Ç—Ä–∏–∫–∏** —á–µ—Ä–µ–∑ Prometheus

> **–í–∞–∂–Ω–æ**: –≠—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–Ω–µ—à–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å—ã. –í—Å–µ –≤–Ω–µ—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ Gateway, –∫–æ—Ç–æ—Ä—ã–π –∑–∞—Ç–µ–º –≤—ã–∑—ã–≤–∞–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ú–Ω–æ–≥–æ—Å–ª–æ–π–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   REST API      ‚îÇ ‚Üê FastAPI –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   Services      ‚îÇ ‚Üê –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Repositories   ‚îÇ ‚Üê DAO —Å–ª–æ–π
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   Database      ‚îÇ ‚Üê SQLAlchemy + PostgreSQL
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

- **REST Layer**: `BillingController` (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã), `HealthController`
- **Service Layer**: `QuotaManager`, `PaymentWebhook`
- **Repository Layer**: `PlanDAO`, `UsageDAO`, `ReceiptDAO`
- **Task Layer**: `CounterResetTask` (cron)

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Gateway   ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Chat-svc  ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Billing   ‚îÇ
‚îÇ             ‚îÇ    ‚îÇ             ‚îÇ    ‚îÇ   Service   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                   ‚îÇ                   ‚ñ≤
       ‚îÇ                   ‚îÇ                   ‚îÇ
       ‚ñº                   ‚ñº                   ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ  Template   ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Pay-svc   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ    -svc     ‚îÇ    ‚îÇ             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

> Gateway –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–Ω–µ—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã Billing Service

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

#### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip install -r requirements.txt

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
pytest tests/ -v

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ –ª–æ–∫–∞–ª—å–Ω–æ
uvicorn app.main:app --reload --host 0.0.0.0 --port 8001

# –ó–∞–ø—É—Å–∫ —Å Docker
docker-compose up -d

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker
docker-compose down

# –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è API
python scripts/demo.py
```

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

#### Linux/macOS:
1. **–ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:**
```bash
git clone <repository>
cd Tarrification-Service
pip install -r requirements.txt
```

2. **–ó–∞–ø—É—Å–∫ —Å Docker Compose:**
```bash
docker-compose up -d
```

3. **–ò–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫:**
```bash
# –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
export DB_DSN="postgresql+asyncpg://user:pass@localhost:5456/billing_db"
export SERVICE_TOKEN="your-secret-token"

# –ó–∞–ø—É—Å–∫
uvicorn app.main:app --reload --port 8001
```

#### Windows:
1. **–ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:**
```powershell
git clone <repository>
cd Tarrification-Service
pip install -r requirements.txt
```

2. **–ó–∞–ø—É—Å–∫ —Å Docker Compose:**
```powershell
docker-compose up -d
```

3. **–ò–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫:**
```powershell
# –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ .env —Ñ–∞–π–ª–µ
# –ó–∞—Ç–µ–º –∑–∞–ø—É—Å–∫:
uvicorn app.main:app --reload --host 0.0.0.0 --port 8001

# –°–µ—Ä–≤–∏—Å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ http://localhost:8001
# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ localhost:5456
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
DB_DSN=postgresql+asyncpg://billing_user:billing_pass@localhost:5456/billing_db

# –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
SERVICE_TOKEN=super-secret-dev

# –°–µ—Ä–≤–∏—Å
SERVICE_NAME=billing-tariffication
SERVICE_VERSION=1.0.0
```

## üì° API Endpoints

### –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ–∂—Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è)

| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|------|----------|
| `GET` | `/internal/billing/quota/check/{user_id}` | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ –∫–≤–æ—Ç |
| `POST` | `/internal/billing/quota/debit` | –°–ø–∏—Å–∞—Ç—å –∫–≤–æ—Ç—É |
| `POST` | `/internal/billing/quota/credit` | –ü–æ–ø–æ–ª–Ω–∏—Ç—å –∫–≤–æ—Ç—É |
| `POST` | `/internal/billing/webhook/payment` | Webhook –æ—Ç Pay-svc |

> **–í–∞–∂–Ω–æ**: –í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ç—Ä–µ–±—É—é—Ç `X-Internal-Key` –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥—Ä—É–≥–∏–º–∏ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º–∏. –í–Ω–µ—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ Gateway.

### Health check

| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|------|----------|
| `GET` | `/health` | –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞ |
| `GET` | `/ready` | Readiness check |
| `GET` | `/metrics` | Prometheus –º–µ—Ç—Ä–∏–∫–∏ |

### –ü—Ä–∏–º–µ—Ä—ã –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ Gateway)
```bash
curl -X GET "http://localhost:8000/internal/billing/quota/check/user-123" \
  -H "X-Internal-Key: super-secret"
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "remain_chat": 54,
  "remain_tpl": 19,
  "plan_code": "free"
}
```

#### –°–ø–∏—Å–∞–Ω–∏–µ –∫–≤–æ—Ç—ã (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ Chat-svc)
```bash
curl -X POST "http://localhost:8000/internal/billing/quota/debit" \
  -H "X-Internal-Key: super-secret" \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "5cdb...",
    "action": "chat_tokens",
    "units": 1,
    "ref": "msg-7f2e4b"
  }'
```

#### –°–ø–∏—Å–∞–Ω–∏–µ –∫–≤–æ—Ç—ã (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ Template-svc)
```bash
curl -X POST "http://localhost:8000/internal/billing/quota/debit" \
  -H "X-Internal-Key: super-secret" \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "5cdb...",
    "action": "tpl_run",
    "units": 1,
    "ref": "req-876c9a"
  }'
```

#### –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–≤–æ—Ç—ã (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ Pay-svc)
```bash
curl -X POST "http://localhost:8000/internal/billing/quota/credit" \
  -H "X-Internal-Key: super-secret" \
  -H "Content-Type: application/json" \
  -d '{
    "order_id": "yka-123",
    "user_id": "5cdb...",
    "plan_code": "pro_month",
    "units_chat": 10000,
    "units_tpl": 200
  }'
```

## üóÑÔ∏è –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü—ã

1. **user_plans** - –¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. **usage_counters** - –°—á–µ—Ç—á–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
3. **payment_receipts** - –ß–µ–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π

### –°—Ö–µ–º–∞ –ë–î

```sql
-- –¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã
CREATE TABLE user_plans (
    id UUID PRIMARY KEY,
    user_id VARCHAR NOT NULL,
    plan_code VARCHAR NOT NULL,
    chat_limit INTEGER NOT NULL DEFAULT 0,
    template_limit INTEGER NOT NULL DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP
);

-- –°—á–µ—Ç—á–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
CREATE TABLE usage_counters (
    id UUID PRIMARY KEY,
    user_id VARCHAR NOT NULL,
    user_plan_id UUID REFERENCES user_plans(id),
    counter_type VARCHAR NOT NULL, -- daily, monthly
    chat_used INTEGER DEFAULT 0,
    template_used INTEGER DEFAULT 0,
    reset_date TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP
);

-- –ß–µ–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π
CREATE TABLE payment_receipts (
    id UUID PRIMARY KEY,
    order_id VARCHAR UNIQUE NOT NULL,
    user_id VARCHAR NOT NULL,
    plan_code VARCHAR NOT NULL,
    amount INTEGER NOT NULL,
    currency VARCHAR DEFAULT 'RUB',
    chat_units_added INTEGER DEFAULT 0,
    template_units_added INTEGER DEFAULT 0,
    payment_status VARCHAR DEFAULT 'pending',
    receipt_data TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP
);
```

## üîß –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
Tarrification-Service/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ main.py                 # FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ config.py              # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ api/                   # REST API
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ billing.py     # –ë–∏–∑–Ω–µ—Å-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ health.py      # Health check
‚îÇ   ‚îú‚îÄ‚îÄ services/              # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ quota_manager.py   # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–≤–æ—Ç–∞–º–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ payment_webhook.py # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ models/                # –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.py        # SQLAlchemy –º–æ–¥–µ–ª–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ schemas.py         # Pydantic —Å—Ö–µ–º—ã
‚îÇ   ‚îú‚îÄ‚îÄ repositories/          # DAO —Å–ª–æ–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base_dao.py        # –ë–∞–∑–æ–≤—ã–π DAO
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ plan_dao.py        # DAO –ø–ª–∞–Ω–æ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ usage_dao.py       # DAO —Å—á–µ—Ç—á–∏–∫–æ–≤
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ receipt_dao.py     # DAO —á–µ–∫–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ database/              # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ connection.py      # SQLAlchemy setup
‚îÇ   ‚îî‚îÄ‚îÄ tasks/                 # –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
‚îÇ       ‚îî‚îÄ‚îÄ counter_reset.py   # –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–æ–≤
‚îú‚îÄ‚îÄ tests/                     # –¢–µ—Å—Ç—ã
‚îú‚îÄ‚îÄ requirements.txt           # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ Dockerfile                 # Docker –æ–±—Ä–∞–∑
‚îú‚îÄ‚îÄ docker-compose.yml         # Docker Compose
‚îî‚îÄ‚îÄ README.md                  # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

#### Linux/macOS:
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip install pytest pytest-asyncio pytest-mock

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
pytest tests/ -v

# –° –ø–æ–∫—Ä—ã—Ç–∏–µ–º
pytest tests/ --cov=app --cov-report=html
```

#### Windows:
```powershell
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
.\run.ps1 test
# –∏–ª–∏
run.bat test

# –ó–∞–ø—É—Å–∫ unit —Ç–µ—Å—Ç–æ–≤
.\run.ps1 test-unit
# –∏–ª–∏
run.bat test-unit

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
.\run.ps1 test-cov
# –∏–ª–∏
run.bat test-cov
```

### –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

```bash
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Alembic
alembic init alembic

# –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
alembic revision --autogenerate -m "Initial migration"

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
alembic upgrade head
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Prometheus –º–µ—Ç—Ä–∏–∫–∏

- `billing_quota_remaining{type="chat|template", user_id="..."}` - –û—Å—Ç–∞—Ç–æ–∫ –∫–≤–æ—Ç
- `billing_deduct_total{result="ok|fail"}` - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ø–∏—Å–∞–Ω–∏–π
- `billing_credit_total` - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π

### Health check

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
curl http://localhost:8000/health

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
curl http://localhost:8000/ready

# –ú–µ—Ç—Ä–∏–∫–∏
curl http://localhost:8000/metrics
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ú–µ–∂—Å–µ—Ä–≤–∏—Å–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ

- **X-Internal-Key** - —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤
- **JWT** - –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –æ—Ç Gateway
- **RSA-SHA-256** - –ø–æ–¥–ø–∏—Å—å webhook'–æ–≤ –æ—Ç –ÆKassa

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
2. –•—Ä–∞–Ω–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ Vault/Kubernetes Secrets
3. –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –ë–î
4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ CORS –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### Docker

```bash
# –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞
docker build -t billing-service .

# –ó–∞–ø—É—Å–∫
docker run -p 8000:8000 \
  -e DB_DSN="postgresql+asyncpg://..." \
  -e SERVICE_TOKEN="..." \
  billing-service
```

### Kubernetes

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: billing-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: billing-service
  template:
    metadata:
      labels:
        app: billing-service
    spec:
      containers:
      - name: billing-service
        image: billing-service:latest
        ports:
        - containerPort: 8000
        env:
        - name: DB_DSN
          valueFrom:
            secretKeyRef:
              name: billing-secrets
              key: db-dsn
        - name: SERVICE_TOKEN
          valueFrom:
            secretKeyRef:
              name: billing-secrets
              key: service-token
```

## ü§ù –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥—Ä—É–≥–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏

### –í Chat-svc

```python
import httpx

async def deduct_chat_quota(user_id: str, units: int, ref: str):
    async with httpx.AsyncClient() as client:
        response = await client.post(
            "http://billing-service:8000/internal/billing/quota/debit",
            headers={"X-Internal-Key": "super-secret"},
            json={
                "user_id": user_id,
                "action": "chat_tokens",
                "units": units,
                "ref": ref
            }
        )
        return response.json()
```

### –í Template-svc

```python
async def deduct_template_quota(user_id: str, units: int, ref: str):
    async with httpx.AsyncClient() as client:
        response = await client.post(
            "http://billing-service:8000/internal/billing/quota/debit",
            headers={"X-Internal-Key": "super-secret"},
            json={
                "user_id": user_id,
                "action": "tpl_run",
                "units": units,
                "ref": ref
            }
        )
        return response.json()
```

### –í Pay-svc

```python
async def credit_quota(order_id: str, user_id: str, plan_code: str):
    async with httpx.AsyncClient() as client:
        response = await client.post(
            "http://billing-service:8000/internal/billing/quota/credit",
            headers={"X-Internal-Key": "super-secret"},
            json={
                "order_id": order_id,
                "user_id": user_id,
                "plan_code": plan_code,
                "units_chat": 10000,
                "units_tpl": 200
            }
        )
        return response.json()
```

### –í Gateway

```python
async def check_user_quota(user_id: str):
    async with httpx.AsyncClient() as client:
        response = await client.get(
            f"http://billing-service:8000/internal/billing/quota/check/{user_id}",
            headers={"X-Internal-Key": "super-secret"}
        )
        return response.json()
```

## üìù TODO

- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É RSA-SHA-256 –ø–æ–¥–ø–∏—Å–∏ –ÆKassa
- [ ] –î–æ–±–∞–≤–∏—Ç—å dead-letter queue –¥–ª—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö webhook'–æ–≤
- [ ] –í—ã–±—Ä–∞—Ç—å –≤–∞–ª—é—Ç—É –ø–ª–∞–Ω–æ–≤ (RUB/USD)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –±–∞–≥-bounty –Ω–∞ –≥–æ–Ω–∫–∏ FOR UPDATE SKIP LOCKED
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å Redis
- [ ] –î–æ–±–∞–≤–∏—Ç—å API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–Ω—ã–º–∏ –ø–ª–∞–Ω–∞–º–∏
- [ ] –°–æ–∑–¥–∞—Ç—å –¥–∞—à–±–æ—Ä–¥ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License 